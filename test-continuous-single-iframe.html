<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Continuous Eye Tracking Test (Single Iframe Architecture)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .question {
      background: white;
      padding: 40px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 400px;
    }

    .question.hidden {
      display: none;
    }

    h1 {
      color: #2c3e50;
      margin-top: 0;
    }

    h2 {
      color: #34495e;
    }

    .next-button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }

    .next-button:hover {
      background: #2980b9;
    }

    .status-panel {
      background: #ecf0f1;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-panel h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .gaze-dot {
      position: fixed;
      width: 15px;
      height: 15px;
      background: red;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.7;
      border: 2px solid white;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      transform: translate(-50%, -50%);
      display: none;
    }

    .data-display {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .data-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .stat-box {
      background: white;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
    }

    .stat-label {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .calibration-container {
      width: 100%;
      height: 700px;
      position: relative;
    }

    #calibration-iframe {
      width: 100%;
      height: 700px;
      border: 2px solid #3498db;
      border-radius: 4px;
    }

    #calibration-iframe.hidden-mode {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 1px;
      height: 1px;
      border: none;
      visibility: hidden;
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>
<body>
  <!-- Gaze visualization dot -->
  <div id="gaze-dot" class="gaze-dot"></div>

  <!-- Single persistent iframe for both calibration and tracking -->
  <iframe id="calibration-iframe"
    src="experiments/calibration.html"
    allow="camera; microphone">
  </iframe>

  <div class="container">
    <h1>Continuous Eye Tracking Test (Single Iframe Architecture)</h1>

    <!-- Status Panel -->
    <div class="status-panel">
      <h3>System Status</h3>
      <div id="system-status">
        <p>Iframe Mode: <strong id="iframe-mode">Calibration</strong></p>
        <p>Current Question: <strong id="current-question">Q1</strong></p>
        <p>Tracking Active: <strong id="tracking-active">No</strong></p>
      </div>

      <div class="data-summary">
        <div class="stat-box">
          <div class="stat-value" id="sample-count">0</div>
          <div class="stat-label">Samples Collected</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="sampling-rate">0</div>
          <div class="stat-label">Hz (Actual)</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="last-coords">-</div>
          <div class="stat-label">Last Gaze (x, y)</div>
        </div>
      </div>

      <label style="display: block; margin-top: 15px;">
        <input type="checkbox" id="show-gaze-dot" checked>
        Show gaze dot (visual feedback)
      </label>
    </div>

    <!-- Question 1: Calibration (iframe is shown above) -->
    <div id="q1" class="question">
      <h2>Question 1: Eye Tracking Calibration</h2>
      <p>Complete the calibration above to enable continuous eye tracking throughout the survey.</p>
      <p style="color: #666; font-size: 14px;">The calibration interface is shown in the iframe above. After calibration, the iframe will be hidden and continue tracking your gaze.</p>
    </div>

    <!-- Question 2: Tracking -->
    <div id="q2" class="question hidden">
      <h2>Question 2: Sample Survey Question</h2>
      <p>This is a sample question where eye tracking is active. Look around the screen and watch the red dot follow your gaze.</p>

      <div style="margin: 30px 0;">
        <h3>What is your favorite color?</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
          <div style="padding: 20px; background: #ffebee; border-radius: 4px; cursor: pointer;">Red</div>
          <div style="padding: 20px; background: #e3f2fd; border-radius: 4px; cursor: pointer;">Blue</div>
          <div style="padding: 20px; background: #e8f5e9; border-radius: 4px; cursor: pointer;">Green</div>
          <div style="padding: 20px; background: #fff9c4; border-radius: 4px; cursor: pointer;">Yellow</div>
        </div>
      </div>

      <h4>Gaze Data for this Question:</h4>
      <div class="data-display" id="q2-data">No data yet...</div>

      <button onclick="nextQuestion()" class="next-button">Next Question</button>
    </div>

    <!-- Question 3: Tracking with Scroll -->
    <div id="q3" class="question hidden">
      <h2>Question 3: Scrolling Content Test</h2>
      <p>This question has more content to test coordinate transformation with scrolling.</p>

      <div style="margin: 30px 0;">
        <h3>Read this content and look at different sections</h3>
        <p style="line-height: 1.8;">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
          Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
        </p>
        <p style="line-height: 1.8;">
          Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
          Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
        </p>
        <p style="line-height: 1.8;">
          Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium,
          totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.
        </p>
        <p style="line-height: 1.8;">
          Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores
          eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet.
        </p>
      </div>

      <h4>Gaze Data for this Question:</h4>
      <div class="data-display" id="q3-data">No data yet...</div>

      <button onclick="finishSurvey()" class="next-button">Finish Survey</button>
    </div>

    <!-- Results -->
    <div id="results" class="question hidden">
      <h2>Test Complete - Collected Data</h2>
      <p>Below is the gaze data that would be saved to Qualtrics embedded data fields.</p>

      <div style="margin-top: 30px;">
        <h3>Question 2 Data</h3>
        <div class="data-display" id="results-q2">-</div>

        <h3 style="margin-top: 20px;">Question 3 Data</h3>
        <div class="data-display" id="results-q3">-</div>
      </div>

      <button onclick="resetTest()" class="next-button" style="margin-top: 20px;">Reset Test</button>
    </div>
  </div>

  <script>
    // State management
    let currentQuestionId = 'q1';
    let questionData = {
      q2: [],
      q3: []
    };
    let questionStartTime = 0;
    let sampleCount = 0;
    let lastSampleTime = 0;
    let modelKey = null;
    let viewportInterval = null;
    let gazeData = []; // Current question's gaze data

    // DOM elements
    const calibrationIframe = document.getElementById('calibration-iframe');
    const gazeDot = document.getElementById('gaze-dot');
    const showDotCheckbox = document.getElementById('show-gaze-dot');

    // Listen for messages from iframe
    window.addEventListener('message', function(event) {
      const data = event.data;

      switch(data.type) {
        case 'calibration-complete':
          handleCalibrationComplete(data);
          break;

        case 'tracking-ready':
          console.log('[Parent] Tracking mode ready');
          document.getElementById('iframe-mode').textContent = 'Tracking (Hidden)';
          break;

        case 'gaze-data':
          handleGazeData(data);
          break;
      }
    });

    // Handle calibration completion
    function handleCalibrationComplete(data) {
      console.log('[Parent] Calibration complete:', data);
      modelKey = data.model_key;

      // Hide the calibration iframe and move it to tracking mode
      calibrationIframe.classList.add('hidden-mode');

      // Wait for tracking-ready, then advance to Q2
      setTimeout(() => {
        nextQuestion();
      }, 1500);
    }

    // Handle incoming gaze data
    function handleGazeData(data) {
      sampleCount++;

      // Calculate actual sampling rate
      const now = performance.now();
      if (lastSampleTime > 0) {
        const actualRate = 1000 / (now - lastSampleTime);
        document.getElementById('sampling-rate').textContent = actualRate.toFixed(1);
      }
      lastSampleTime = now;

      // Update UI
      document.getElementById('sample-count').textContent = sampleCount;
      document.getElementById('last-coords').textContent = `${Math.round(data.x)}, ${Math.round(data.y)}`;
      document.getElementById('tracking-active').textContent = 'Yes';

      // Update gaze dot position
      if (showDotCheckbox.checked) {
        gazeDot.style.display = 'block';
        gazeDot.style.left = data.x + 'px';
        gazeDot.style.top = data.y + 'px';
      } else {
        gazeDot.style.display = 'none';
      }

      // Store data for current question
      if (currentQuestionId === 'q2' || currentQuestionId === 'q3') {
        const relativeTime = data.timestamp - questionStartTime;
        gazeData.push({
          t: Math.round(relativeTime),
          x: Math.round(data.x),
          y: Math.round(data.y)
        });

        // Update question data display
        const dataDisplay = document.getElementById(currentQuestionId + '-data');
        if (dataDisplay) {
          const compressed = gazeData.slice(-10).map(d => `${d.t},${d.x},${d.y}`).join('|');
          dataDisplay.textContent = `Samples: ${gazeData.length}\n\nLast 10 samples:\n${compressed}`;
        }
      }
    }

    // Navigate to next question
    function nextQuestion() {
      // Pause tracking
      calibrationIframe.contentWindow.postMessage({ type: 'pause-tracking' }, '*');
      document.getElementById('tracking-active').textContent = 'No';

      // Clear viewport interval
      if (viewportInterval) {
        clearInterval(viewportInterval);
        viewportInterval = null;
      }

      // Save data from current question if applicable
      if (currentQuestionId === 'q2' || currentQuestionId === 'q3') {
        questionData[currentQuestionId] = gazeData;
      }

      // Hide current question
      document.getElementById(currentQuestionId).classList.add('hidden');

      // Show next question
      if (currentQuestionId === 'q1') {
        currentQuestionId = 'q2';
        startTracking('q2');
      } else if (currentQuestionId === 'q2') {
        currentQuestionId = 'q3';
        startTracking('q3');
      }

      document.getElementById(currentQuestionId).classList.remove('hidden');
      document.getElementById('current-question').textContent = currentQuestionId.toUpperCase();

      // Reset sample count for new question
      sampleCount = 0;
      window.scrollTo(0, 0);
    }

    // Start tracking for a question
    function startTracking(questionId) {
      questionStartTime = performance.now();
      gazeData = [];

      // Send start command to iframe
      calibrationIframe.contentWindow.postMessage({
        type: 'start-tracking',
        questionId: questionId,
        questionStartTime: questionStartTime
      }, '*');

      // Send viewport updates periodically
      viewportInterval = setInterval(function() {
        calibrationIframe.contentWindow.postMessage({
          type: 'viewport-update',
          scrollX: window.scrollX,
          scrollY: window.scrollY
        }, '*');
      }, 100);
    }

    // Finish survey and show results
    function finishSurvey() {
      // Pause tracking
      calibrationIframe.contentWindow.postMessage({ type: 'pause-tracking' }, '*');
      document.getElementById('tracking-active').textContent = 'No';

      // Clear viewport interval
      if (viewportInterval) {
        clearInterval(viewportInterval);
      }

      // Save data from Q3
      questionData.q3 = gazeData;

      // Hide current question
      document.getElementById(currentQuestionId).classList.add('hidden');

      // Show results
      document.getElementById('results').classList.remove('hidden');
      document.getElementById('current-question').textContent = 'Results';

      // Display collected data
      const q2Compressed = questionData.q2.map(d => `${d.t},${d.x},${d.y}`).join('|');
      const q3Compressed = questionData.q3.map(d => `${d.t},${d.x},${d.y}`).join('|');

      document.getElementById('results-q2').textContent =
        `Samples: ${questionData.q2.length}\nCompressed format:\n${q2Compressed.substring(0, 200)}${q2Compressed.length > 200 ? '...' : ''}`;
      document.getElementById('results-q3').textContent =
        `Samples: ${questionData.q3.length}\nCompressed format:\n${q3Compressed.substring(0, 200)}${q3Compressed.length > 200 ? '...' : ''}`;
    }

    // Reset test
    function resetTest() {
      location.reload();
    }

    console.log('[Parent] Test environment loaded. Complete calibration to begin tracking...');
  </script>
</body>
</html>
