<!DOCTYPE html>
<html>

<head>
    <title>Advanced WebGazer Diagnostic</title>
    <!-- Use WebGazer 2.2.4 (More Qualtrics-compatible) -->
    <script src="https://cdn.jsdelivr.net/npm/webgazer@2.2.4/dist/webgazer.min.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
        }

        .box {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .pass {
            color: green;
            font-weight: bold;
        }

        .fail {
            color: red;
            font-weight: bold;
        }

        .warn {
            color: orange;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background: #0056b3;
        }

        #logs {
            white-space: pre-wrap;
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>Legacy WebGazer Diagnostic (clmtrackr check)</h1>

    <div class="box">
        <h3>1. Environment Check</h3>
        <div id="env-results"></div>
        <button onclick="checkEnv()">Run Environment Check</button>
    </div>

    <div class="box">
        <h3>2. WebGazer Introspection</h3>
        <div id="intro-results"></div>
        <button onclick="checkWebGazer()">Inspect WebGazer Modules</button>
    </div>

    <div class="box">
        <h3>3. Camera & Start Test</h3>
        <button onclick="startTest()">Attempt Start</button>
        <div id="start-results"></div>
        <div id="video-container" style="margin-top:10px;"></div>
    </div>

    <div class="box">
        <h3>Console Logs</h3>
        <div id="logs"></div>
    </div>

    <script>
        function log(msg) {
            var d = document.createElement('div');
            d.textContent = "> " + msg;
            document.getElementById('logs').appendChild(d);
            console.log(msg);
        }

        function printResult(id, msg, status) {
            var el = document.getElementById(id);
            el.innerHTML += `<div class="${status}">${msg}</div>`;
        }

        async function checkEnv() {
            document.getElementById('env-results').innerHTML = "";

            // WebGL Check
            var canvas = document.createElement('canvas');
            var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (gl) printResult('env-results', "PASS: WebGL is supported", "pass");
            else printResult('env-results', "FAIL: WebGL not supported (Hardware Acceleration disabled?)", "fail");

            // Secure Context Check
            if (window.isSecureContext) printResult('env-results', "PASS: Secure Context (HTTPS/Localhost)", "pass");
            else printResult('env-results', "FAIL: Insecure Context (Camera will be blocked)", "fail");

            // Camera Permission Check (Quick)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                printResult('env-results', "PASS: Camera access granted", "pass");
                stream.getTracks().forEach(t => t.stop()); // Close immediately
            } catch (e) {
                printResult('env-results', "FAIL: Camera access denied: " + e.message, "fail");
            }
        }

        function checkWebGazer() {
            document.getElementById('intro-results').innerHTML = "";

            if (typeof webgazer === 'undefined') {
                printResult('intro-results', "FAIL: WebGazer object not found", "fail");
                return;
            }
            printResult('intro-results', "PASS: WebGazer object loaded", "pass");

            // Introspect Trackers
            // Note: Older versions might use different internal structures, but let's check standard ones
            var trackers = Object.keys(webgazer._trackerMap || webgazer._trackers || {});
            log("Available Trackers: " + JSON.stringify(trackers));

            if (trackers.includes('clmtrackr')) {
                printResult('intro-results', "SUCCESS: clmtrackr found!", "pass");
            } else if (trackers.length > 0) {
                printResult('intro-results', "Trackers found: " + trackers.join(", "), "pass");
            } else {
                printResult('intro-results', "WARN: No trackers found (or legacy structure)", "warn");
            }

            // Introspect Regressions
            var regs = Object.keys(webgazer._regressionMap || webgazer._regs || {});
            log("Available Regressions: " + JSON.stringify(regs));
            if (regs.length > 0) printResult('intro-results', "Regressions found: " + regs.join(", "), "pass");
            else printResult('intro-results', "WARN: No regressions found in _regressionMap", "warn");
        }

        function startTest() {
            document.getElementById('start-results').innerHTML = "Initializing...";

            // Legacy versions might not have saveDataAcrossSessions
            try { webgazer.saveDataAcrossSessions(false); } catch (e) { }
            try { if (webgazer.clearData) webgazer.clearData(); } catch (e) { }

            // Force TFFacemesh if available
            try {
                webgazer.setRegression('ridge')
                    .setTracker('TFFacemesh');
                log("âœ“ Set tracker to TFFacemesh with ridge regression");
            } catch (e) {
                log("Could not set tracker explicitly: " + e.message);
                log("Will use WebGazer defaults");
            }

            // 4. Begin
            webgazer.begin()
                .then(() => {
                    printResult('start-results', "SUCCESS: WebGazer started (Legacy Mode)", "pass");
                    webgazer.showVideo(true);
                    webgazer.showFaceOverlay(true);
                    webgazer.showPredictionPoints(true);

                    // Move video to container
                    setTimeout(() => {
                        var v = document.getElementById('webgazerVideoContainer');
                        if (v) {
                            v.style.position = 'static';
                            document.getElementById('video-container').appendChild(v);
                        }
                    }, 1000);
                })
                .catch(err => {
                    printResult('start-results', "CRASH: " + err.message, "fail");
                    log("Full Error: " + err.stack);
                });
        }
    </script>
</body>

</html>