<!-- Minimal jsPsych Eye Tracking Calibration for Qualtrics -->
<!-- Just camera init + calibration + validation, then continues survey -->

<script src="https://unpkg.com/jspsych@8.2.2"></script>
<script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
<script src="https://unpkg.com/@jspsych/plugin-webgazer-init-camera@2.1.0"></script>
<script src="https://unpkg.com/@jspsych/plugin-webgazer-calibrate@2.1.0"></script>
<script src="https://unpkg.com/@jspsych/plugin-webgazer-validate@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@7.0.0/examples/js/webgazer/webgazer.js"></script>
<script src="https://unpkg.com/@jspsych/extension-webgazer@1.2.0"></script>
<link rel="stylesheet" href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" />

<div id="jspsych-target"></div>

<script>
  var jsPsych = initJsPsych({
    extensions: [{ type: jsPsychExtensionWebgazer }],
    on_finish: function(data) {
      // Save calibration data
      if (typeof Qualtrics !== 'undefined') {
        var validation = jsPsych.data.get().filter({trial_type: 'webgazer-validate'}).values()[0];
        Qualtrics.SurveyEngine.setEmbeddedData('eyetracking_validation', JSON.stringify(validation));
        Qualtrics.SurveyEngine.setEmbeddedData('eyetracking_average_offset', validation.average_offset);
        Qualtrics.SurveyEngine.setEmbeddedData('eyetracking_percent_in_roi', validation.percent_in_roi.join(','));
      }

      // Auto-advance to next question
      setTimeout(function() {
        if (typeof Qualtrics !== 'undefined') {
          document.querySelector('#NextButton').click();
        }
      }, 1000);
    }
  });

  var timeline = [];

  // Welcome
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h2>Eye Tracking Setup</h2><p>Click below to enable your camera and calibrate eye tracking.</p>',
    choices: ['Start']
  });

  // Initialize camera
  timeline.push({
    type: jsPsychWebgazerInitCamera
  });

  // Calibration
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p><strong>Calibration:</strong> Look at each dot and click on it.</p>',
    choices: ['Begin Calibration']
  });

  timeline.push({
    type: jsPsychWebgazerCalibrate,
    calibration_points: [[25,25], [75,25], [50,50], [25,75], [75,75]],
    repetitions_per_point: 2
  });

  // Validation
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p><strong>Validation:</strong> Look at each dot (DO NOT click).</p>',
    choices: ['Begin Validation']
  });

  timeline.push({
    type: jsPsychWebgazerValidate,
    validation_points: [[25,25], [75,25], [50,50], [25,75], [75,75]],
    show_validation_data: true
  });

  // Done
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h3>âœ“ Calibration Complete!</h3><p>Continuing to survey...</p>',
    choices: [],
    trial_duration: 1000
  });

  jsPsych.run(timeline);
</script>

<style>
  #NextButton { display: none !important; }
</style>
