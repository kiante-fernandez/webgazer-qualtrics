<!-- WebGazer Integration for Qualtrics -->
<!-- Paste this into: Look & Feel -> General -> Header -->

<!-- Load WebGazer 3.4.0 (standalone - includes all dependencies) -->
<script>
    // Prevent double loading
    if (!window.webgazerLoading && !window.webgazerLibraryLoaded) {
        window.webgazerLoading = true;

        var script = document.createElement('script');

        // IMPORTANT: You must host the 'dist/webgazer-patched.js' file on a server (e.g. GitHub Pages, JSDelivr)
        // and replace the URL below with your hosted URL.
        // The default CDN version contains 'eval' which is blocked by Qualtrics.
        // script.src = 'https://cdn.jsdelivr.net/gh/jspsych/jsPsych@7.0.0/examples/js/webgazer/webgazer.js'; // BLOCKED BY CSP

        // Example: If you host it on GitHub Pages:
        // script.src = 'https://your-username.github.io/your-repo/dist/webgazer-patched.js';

        // For now, using a placeholder to remind you to update it:
        script.src = 'INSERT_YOUR_HOSTED_WEBGAZER_PATCHED_JS_URL_HERE';

        script.async = false;

        script.onload = function () {
            console.log("✓ WebGazer library loaded");
            window.webgazerLibraryLoaded = true;
            window.webgazerLoading = false;

            if (typeof webgazer !== 'undefined') {
                console.log("✓ webgazer object confirmed");
            } else {
                console.error("✗ Script loaded but webgazer object not found");
            }
        };

        script.onerror = function (e) {
            console.error("✗ Failed to load WebGazer:", e);
            window.webgazerLibraryLoaded = false;
            window.webgazerLoading = false;
            alert("Failed to load eye tracking library. Please check your internet connection.");
        };

        document.head.appendChild(script);
        console.log("Loading WebGazer...");
    }
</script>

<!-- INLINE CSS -->
<style>
    /* Calibration Points */
    .calibration-point {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: red;
        opacity: 0.7;
        position: fixed;
        z-index: 9999;
        cursor: pointer;
        display: none;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        transition: transform 0.2s;
    }

    .calibration-point:hover {
        transform: scale(1.2);
    }

    .calibration-point.calibrated {
        background-color: green;
        opacity: 0.9;
    }

    /* Video Feed */
    #webgazerVideoContainer {
        position: fixed !important;
        top: 10px !important;
        left: 10px !important;
        z-index: 9998 !important;
        border: 3px solid #333;
        border-radius: 5px;
        width: 320px !important;
        height: 240px !important;
    }

    #webgazerFaceOverlay {
        position: fixed !important;
        top: 10px !important;
        left: 10px !important;
        z-index: 9999 !important;
        border: 2px solid limegreen;
        pointer-events: none;
        width: 320px !important;
        height: 240px !important;
    }

    /* Start Overlay */
    #webgazer-start-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 100000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: sans-serif;
    }

    #webgazer-start-btn {
        padding: 15px 30px;
        font-size: 20px;
        background: #007ac0;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }

    #webgazer-start-btn:hover {
        background: #005f96;
    }
</style>

<!-- Start Overlay HTML -->
<div id="webgazer-start-overlay">
    <h1>Eye Tracking Setup</h1>
    <p>We need to access your camera for this survey.</p>
    <button id="webgazer-start-btn" onclick="window.webgazerGlobal.startWebGazer()">Enable Camera & Start</button>
</div>

<script>
    console.log("WebGazer Header Loaded");

    window.webgazerGlobal = {
        isReady: false,
        isInitializing: false,
        isRecording: false,
        data: [],

        startWebGazer: function () {
            var that = this;

            // Prevent double initialization
            if (this.isInitializing || this.isReady) {
                console.warn("⚠ WebGazer already initializing or ready");
                return;
            }

            this.isInitializing = true;
            var btn = document.getElementById('webgazer-start-btn');
            if (btn) btn.innerText = "Initializing...";

            // Wait for library to load
            function waitForLibrary() {
                if (typeof webgazer === 'undefined') {
                    console.log("Waiting for WebGazer library...");

                    var waitAttempts = 0;
                    var waitInterval = setInterval(function () {
                        waitAttempts++;

                        if (typeof webgazer !== 'undefined') {
                            clearInterval(waitInterval);
                            console.log("✓ WebGazer library ready");
                            startInitialization();
                            return;
                        }

                        if (waitAttempts >= 50) { // 5 seconds
                            clearInterval(waitInterval);
                            alert("WebGazer library failed to load. Please refresh the page.");
                            if (btn) btn.innerText = "Failed - Refresh Page";
                            that.isInitializing = false;
                        }
                    }, 100);
                    return;
                }

                startInitialization();
            }

            function startInitialization() {
                console.log("Starting WebGazer initialization...");

                // Configure WebGazer
                try {
                    webgazer.saveDataAcrossSessions(false);
                    // NOTE: NOT calling setRegression() before begin() - let WebGazer use defaults
                    // Official WebGazer example doesn't configure regression/tracker before begin()
                    // See: https://github.com/brownhci/WebGazer/blob/master/www/index.html
                    console.log("✓ Configured: no persistence, using default regression");
                } catch (e) {
                    console.warn("Configuration warning:", e.message);
                }

                // Start WebGazer
                webgazer.begin()
                    .then(function () {
                        console.log("✓ WebGazer.begin() resolved");

                        // Wait for video stream
                        waitForVideoStream(function (videoReady) {
                            if (!videoReady) {
                                alert("Camera stream failed. Please check permissions and try again.");
                                if (btn) btn.innerText = "Retry Camera";
                                that.isInitializing = false;
                                return;
                            }

                            // Setup UI
                            that.setupUI();

                            // Wait for tracker to warm up
                            setTimeout(function () {
                                checkTrackerReady(function (success) {
                                    if (success) {
                                        var overlay = document.getElementById('webgazer-start-overlay');
                                        if (overlay) overlay.style.display = 'none';
                                        sessionStorage.setItem('webgazer_auth', 'true');
                                        that.isReady = true;
                                        that.isInitializing = false;
                                        console.log("✓ WebGazer FULLY ready for use");
                                    } else {
                                        alert("Tracker failed to initialize. Please refresh and try again.");
                                        that.isInitializing = false;
                                    }
                                });
                            }, 2000); // 2 second warmup
                        });
                    })
                    .catch(function (err) {
                        console.error("✗ WebGazer failed to start:", err);

                        var errorMsg = "Failed to start eye tracking.\n\n";
                        if (err.message.includes('camera') || err.message.includes('getUserMedia') ||
                            err.message.includes('permission')) {
                            errorMsg += "Cannot access camera. Please grant camera permissions.";
                        } else if (err.message.includes('NotAllowedError')) {
                            errorMsg += "Camera permission denied. Please allow camera access and refresh.";
                        } else {
                            errorMsg += "Error: " + err.message;
                        }

                        alert(errorMsg);
                        if (btn) btn.innerText = "Retry Camera";
                        that.isInitializing = false;
                    });

                // Setup gaze listener
                webgazer.setGazeListener(function (data, elapsedTime) {
                    if (data == null) return;
                    if (window.webgazerGlobal.isRecording) {
                        window.webgazerGlobal.data.push({
                            x: Math.round(data.x),
                            y: Math.round(data.y),
                            t: elapsedTime,
                            p: window.location.href
                        });
                    }
                });
            }

            function waitForVideoStream(callback) {
                var attempts = 0;
                var maxAttempts = 150; // 15 seconds

                var checkInterval = setInterval(function () {
                    attempts++;

                    var videoContainer = document.getElementById('webgazerVideoContainer');
                    var video = videoContainer ? videoContainer.querySelector('video') : null;

                    var hasStream = video && video.srcObject && video.srcObject.active;
                    var hasValidDimensions = video && video.videoWidth > 0 && video.videoHeight > 0;
                    var isPlaying = video && video.readyState >= 2;

                    if (attempts === 1) {
                        console.log("Waiting for video stream...");
                    }

                    if (attempts % 20 === 0) {
                        console.log("Still waiting... (attempt " + attempts + ")");
                    }

                    if (hasStream && hasValidDimensions && isPlaying) {
                        clearInterval(checkInterval);
                        console.log("✓ Video stream ready: " + video.videoWidth + "x" + video.videoHeight);
                        callback(true);
                        return;
                    }

                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error("✗ Video stream timeout");
                        callback(false);
                    }
                }, 100);
            }

            function checkTrackerReady(callback) {
                var attempts = 0;
                var maxAttempts = 150; // 15 seconds

                var checkInterval = setInterval(function () {
                    attempts++;

                    try {
                        var testPred = webgazer.getCurrentPrediction();
                        if (testPred && typeof testPred.x === 'number' && !isNaN(testPred.x)) {
                            clearInterval(checkInterval);
                            console.log("✓ Tracker producing valid predictions");
                            callback(true);
                            return;
                        }
                    } catch (e) {
                        if (attempts % 20 === 0) {
                            console.log("Warming up tracker... (attempt " + attempts + ")");
                        }
                    }

                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error("✗ Tracker timeout");
                        callback(false);
                    }
                }, 100);
            }

            waitForLibrary();
        },

        setupUI: function () {
            try {
                webgazer.showVideo(true);
                webgazer.showFaceOverlay(true);
                webgazer.showPredictionPoints(true);

                var v = document.getElementById('webgazerVideoContainer');
                if (v) {
                    v.style.top = '10px';
                    v.style.left = '10px';
                    v.style.position = 'fixed';
                    console.log("✓ Video UI configured");
                }
            } catch (e) {
                console.error("UI setup error:", e);
            }
        },

        startRecording: function () { this.isRecording = true; },
        stopRecording: function () { this.isRecording = false; },
        saveData: function () {
            if (window.Qualtrics && window.Qualtrics.SurveyEngine) {
                Qualtrics.SurveyEngine.setEmbeddedData('GazeData', JSON.stringify(this.data));
            }
        }
    };

    // Auto-start if previously authorized
    if (sessionStorage.getItem('webgazer_auth') === 'true') {
        console.log("Auto-starting WebGazer (Previously Authorized)");

        function tryAutoStart() {
            if (typeof webgazer !== 'undefined') {
                if (!window.webgazerGlobal.isReady && !window.webgazerGlobal.isInitializing) {
                    var overlay = document.getElementById('webgazer-start-overlay');
                    if (overlay) {
                        overlay.innerHTML = "<h1>Resuming Eye Tracking...</h1>";
                    }
                    window.webgazerGlobal.startWebGazer();
                }
            } else {
                setTimeout(tryAutoStart, 200);
            }
        }

        setTimeout(tryAutoStart, 500);
    }

    // Cleanup on unload
    window.addEventListener('beforeunload', function () {
        if (typeof webgazer !== 'undefined') {
            try { webgazer.end(); } catch (e) { }
        }
    });
</script>